name: 'Verify Squashed Commits'
description: 'Verifies that commits in a pull request have been squashed'

inputs:
  max-commits:
    description: 'Maximum number of commits allowed (default: 1 for squashed PR)'
    required: false
    default: '1'

runs:
  using: 'composite'
  steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      with:
        persist-credentials: false
        fetch-depth: 0

    - name: Check commit count
      id: check-commits
      shell: bash
      env:
        MAX_COMMITS: ${{ inputs.max-commits }}
        PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
        PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        PR_BASE_REF: ${{ github.event.pull_request.base.ref }}
      run: |
        # Get base and head refs from GitHub context
        if [ -z "$PR_BASE_SHA" ]; then
          echo "::error::This action must be run on a pull request event"
          exit 1
        fi

        BASE_SHA="$PR_BASE_SHA"
        HEAD_SHA="$PR_HEAD_SHA"

        # Fetch the base branch to ensure we have the commits
        git fetch origin "$PR_BASE_REF"

        # Count commits in the PR using git
        COMMIT_COUNT=$(git rev-list --count "$BASE_SHA..$HEAD_SHA")

        echo "Found $COMMIT_COUNT commit(s) in PR"

        # Check if squashed
        if [ "$COMMIT_COUNT" -le "$MAX_COMMITS" ]; then
          echo "PR is squashed ($COMMIT_COUNT commit(s), max allowed: $MAX_COMMITS)"
        else
          echo "::error::PR is not squashed ($COMMIT_COUNT commit(s), max allowed: $MAX_COMMITS)"
          echo "::error::Please squash your commits before merging"
          exit 1
        fi
